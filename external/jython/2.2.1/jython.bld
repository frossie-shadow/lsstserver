#
# build script for jython
#
# Jython requires Java; however, the Sun version is not delivered via the 
# server (for licensing issues).  This script will prefer when building a 
# version of Java (or JDK) that is registered with EUPS if available.  Otherwise,
# it will then prefer one pointed to via JAVA_HOME.  Failing that it will rely
# on java in the current PATH.  
#
[ -n "$EUPS_DIR" ] || {
    echo EUPS is not setup. | tee -a $buildlog
    false
}

# if java or jdk are registered with eups (and marked Current) set one of them
# up and use it.  
#
if [ -z "$SETUP_JAVA" -a -z "$SETUP_JDK" ]; then
    SHELL=/bin/bash
    eval `grep 'function setup' $EUPS_DIR/bin/setups.sh`
    eval `grep 'function unsetup' $EUPS_DIR/bin/setups.sh`
    { eups list java | egrep -q 'Current'; } && setup java
    [ $? -ne 0 ] && { eups list jdk | egrep -q 'Current'; } && setup jdk
fi

if [ -n "$SETUP_JAVA" -a -n "$JAVA_DIR" ]; then
    export JAVA_HOME=$JAVA_DIR
    PATH=$JAVA_DIR/bin:$PATH
    wjava=JAVA
elif [ -n "$SETUP_JDK" -a -n "$JDK_DIR" ]; then
    export JAVA_HOME=$JAVA_DIR
    PATH=$JAVA_DIR/bin:$PATH
    wjava=JDK
elif [ -n "$JAVA_HOME" ]; then
    PATH=$JAVA_HOME/bin:$PATH
fi

which java > /dev/null 2>&1 || {
    echo "Can't find java executable"
    false
}

fetch external/jython/$version/jython_installer-${version}.jar
echo java -jar jython_installer-${version}.jar -d $installdir --verbose -t standard -s | tee -a $buildlog
java -jar jython_installer-${version}.jar -d $installdir --verbose -t standard -s >> $buildlog 2>&1

# if Java is registered with EUPS, update the jython wrapper script to use which 
# ever version is setup
if [ -n "$wjava" ]; then
    cp $installdir/jython $installdir/jython-exec
    sed -e '/org.python.util.jython/ s/^"[^"][^"]*"/"$'$wjava'_DIR\/bin\/java"/' \
        -e '/^# Created/ a # Modified by lssteups\n[ -n "$JAVA_DIR" ] || { echo "Java is not setup."; exit 1; }' \
        $installdir/jython-exec > $installdir/jython
fi

if [ -z "$wjava" ]; then
    # no registered Java
    tfile="$product.table"
    fetch external/$product/$version/$tfile
    echo mkdir -p $installdir/ups >> $buildlog
    mkdir -p $installdir/ups 2>&1 | tee -a $buildlog 
    echo cp $tfile $installdir/ups/${product}.table >> $buildlog 
    cp $tfile $installdir/ups/${product}.table 2>&1 | tee -a $buildlog 
else
    # Java is registered with EUPS as $wjava; incorporate this into 
    # our table file
    echo "Adding dependency on EUPS-registered Java into table file" | \
        tee -a $buildlog
    tfile="$product-witheupsjava.table"
    fetch external/$product/$version/$tfile
    echo mkdir -p $installdir/ups >> $buildlog
    mkdir -p $installdir/ups 2>&1 | tee -a $buildlog 
    echo sed -e "s/setupRequired(java,/setupRequired($wjava/" $tfile >> $buildlog
    sed -e "s/setupRequired(java,/setupRequired($wjava/" $tfile \
       > $installdir/ups/${product}.table
fi

eups declare $product $version -r $installdir
